#!/usr/bin/env python
""" Simple server to automate chatter with github """

import yaml
import logging
import flask
import json

import chatter.bot

config=yaml.load(file('/var/lib/chatter/config.yaml','r'))
app = flask.Flask(__name__)
logging.basicConfig(filename=config['log_file'], level=logging.INFO)
logging.info("============================================================")

@app.route('/chatter/', methods=['GET','POST'])
def github_destination():
    if flask.request.method == 'GET':
        logging.info("Chattering! GET")
        return "Success", 200
    elif flask.request.method == 'POST':
        payload = flask.request.get_json()
        event_type = flask.request.headers.get('X-Github-Event')
        if event_type == 'issue_comment':
            if 'pull_request' not in payload['issue']:
                logging.info("Issue is not a pull request; nothing to do")
            else:
                # Check if code review is complete
                token = config['github_auth_token']
                issue = payload['issue']['number']
                descriptions = {
                    'success': "Code review completed.",
                    'failure': "Code was rejected by review.",
                    'error': "There was an error reviewing code?",
                    'pending': "Code review pending."}
                try:
                    bot = chatter.bot.JenkinsBot(token)
                    comment, sha = bot.pr_reviewed_by(issue)
                    if comment is not None:
                        description = "Pull request reviewed by @{}".format(
                                comment['user']['login'])
                        logging.info(description)
                        status = {
                                'context': 'code_review',
                                'state': 'success',
                                'target_url': comment['html_url'],
                                'description': description}
                        bot.set_status(sha, status)

                except RuntimeError:
                    logging.exception()
        elif event_type == 'pull_request':
            logging.info("New pull request.")
        else:
            logging.info("Unexpected event type {}".format(event_type))
        return "Post acknowledged", 204

@app.route('/chatter/pr/<num>')
def check_pr(num=None):
    token = config['github_auth_token']
    try:
        bot = chatter.bot.JenkinsBot(token)
        reviewed_by = bot.pr_reviewed_by(num)
    except RuntimeError:
        logging.exception()

    if reviewed_by is None:
        return "Pull request has not been reviewed"
    else:
        return "Pull request reviewed by @{}".format(reviewed_by['login'])
